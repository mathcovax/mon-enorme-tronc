<script setup lang="ts">
import PrimaryButton from "@/components/PrimaryButton.vue";
import { useEditUserProfilForm } from "../composables/useEditUserProfilForm";

const $pt = usePageTranslate();

const userStore = useUserStore();

const {
	EditUserProfilForm,
	checkEditUserProfilForm,
} = useEditUserProfilForm(userStore.user?.id);

function deleteAccount() { // TODO: check relation with other entities
	duploTo.enriched
		.delete("/user")
		.result;

	// userStore.removeAccessToken();
}

async function submit() {
	const formFields = await checkEditUserProfilForm();

	console.log(formFields);

	if (!formFields) {
		return;
	}

	await duploTo.enriched
		.patch(
			"/user",
			{
				lastname: formFields.lastname,
				firstname: formFields.firstname,
				address: formFields.address,
			},
		)
		.result;
}
</script>

<template>
	<section class="h-screen-no-header">
		<div class="container h-[calc(100%-3rem)] mt-12 lg:mt-16 flex flex-col gap-12">
			<h1 class="text-2xl lg:text-3xl font-bold">
				{{ $pt("title") }}
			</h1>

			<div class="mx-auto grid w-full items-start gap-6 md:grid-cols-[180px_1fr] lg:grid-cols-[250px_1fr]">
				<aside class="flex flex-col gap-4 items-center text-sm text-muted-foreground">
					<div class="w-32 h-32 rounded-full bg-secondary flex items-center justify-center">
						<TheIcon
							icon="account-outline"
							size="3xl"
						/>
					</div>

					<div class="text-center">
						{{ userStore.user?.firstname }} {{ userStore.user?.lastname }}
					</div>
				</aside>

				<div class="grid gap-6">
					<EditUserProfilForm 
						@submit="submit"
					>
						<PrimaryButton
							type="submit"
							class="col-span-12"
						>
							{{ $t("button.save") }}
						</PrimaryButton>
					</EditUserProfilForm>

					<WithValidation
						:title="$pt('popup.title')"
						:content="$pt('popup.content')"
						@validate="deleteAccount"
					>
						<PrimaryButton
							variant="destructive"
							class="w-full"
						>
							{{ $pt("deletAccount") }}
						</PrimaryButton>
					</WithValidation>
				</div>
			</div>
		</div>
	</section>
</template>
